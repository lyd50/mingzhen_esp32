#include "EdpKit.h"
#include "hz.c"
#include "canshu.h"
#include "Lyd.h"
#include <ArduinoOTA.h>
#include <stdlib.h>

#include <Arduino.h>
#include <HardwareSerial.h>
#include <WiFi.h>
#include <WiFiClient.h>
#include <WebServer.h>
#include <ESPmDNS.h>

#include <Update.h>
#include "EEPROM.h"
#include <WiFiUdp.h>
#include "canshu.h"
#include <rom/rtc.h>
/*--------------------------------温度-------------------------------------------*/
 OneWire oneWire(18); //????
 DallasTemperature sensors(&oneWire);
 DeviceAddress address_18b20;
//bool 18b20_ok?=false;
 float tempC;
 //unsigned long begintime_wendu;

char str[10];

/*--------------------------------????-------------------------------------------*/
unsigned long jingshui_chaoya_begin = 0;

const int maxAllowedWrites = 80;
/*-------------????buffer, ????buffer, EDP????????-------------------------*/

void setup()
{
	{
		pinMode(diyakg, INPUT_PULLUP);
		pinMode(ximo_gaoyakg, INPUT_PULLUP);
		pinMode(yinyong_gaoyakg, INPUT_PULLUP);
		pinMode(shengchan_gaoyakg, INPUT_PULLUP);
		pinMode(jingshui_chaoyakg, INPUT_PULLUP);
		pinMode(shuiliu_chuanganqi, INPUT_PULLUP);

		pinMode(chaolv, OUTPUT);
		pinMode(jingshui, OUTPUT);
		pinMode(gaoyabeng, OUTPUT);
		pinMode(youxian, OUTPUT);
		pinMode(zongjin, OUTPUT);
		pinMode(jiare, OUTPUT);
	}
	digitalWrite(zongjin, HIGH); //为了先打开进水+-

	Serial.begin(9600); //?????????

	Serial1.begin(9600); //?????????
	Serial2.begin(9600);

	/*----------------------------------WiFi????--------------------------------------*/
	WiFi.mode(WIFI_AP_STA);
	// Connect to WiFi network
	WiFi.begin(wifi_ssid.c_str(), wifi_pass.c_str());

	Serial.println("");

	// Wait for connection
	if (WiFi.status() != WL_CONNECTED)
	{
		for (int i = 0; i < 20;)
		{
			delay(500);
			Serial.print(".");
			i++;
		}
	}
	if (WiFi.status() == WL_CONNECTED)
	{
		Serial.println("");
		Serial.print("Connected to ");
		Serial.println(wifi_ssid);
		Serial.print("IP address: ");
		Serial.println(WiFi.localIP());

		former_wifi_ssid = wifi_ssid; //????????
		former_wifi_pass = wifi_pass; //????????
		wifi_disconnect_count = 0;
		edp_first_connect(); //edp第一次连接
	}

	/*----------------------------------上报启动原因-------------------------------------*/
	Serial.println("CPU0 reset reason:");
  print_reset_reason(rtc_get_reset_reason(0));
  verbose_print_reset_reason(rtc_get_reset_reason(0));
  if (edpConnected == true)
	{ edp_upload_string("reset_reason",reason1);
      edp_upload_string("reset_reason",reason2);
	}

  Serial.println("CPU1 reset reason:");
  print_reset_reason(rtc_get_reset_reason(1));
  verbose_print_reset_reason(rtc_get_reset_reason(1));

if (edpConnected == true)
	{ edp_upload_string("reset_reason",reason1);
      edp_upload_string("reset_reason",reason2);
	}

	

	/*----------------------------------OTA--------------------------------------*/


	closeall();
	digitalWrite(zongjin, HIGH); //为了先打开进水，总进不能关闭
	/*------------------------------EEPROM ????????-------------------------------*/
	eeprom_read();
	// brightness = p.getChar("brightness", 20); //??????????
	/*-------------------------????------------------------------*/
	sensors.begin();
	if (!sensors.getAddress(address_18b20, 0))
		Serial.println("Unable to find address for Device 0");

	chaolv_chxi = true; //?????????锟斤拷???

	Serial2.print("page 0"); //到首页
	for (int i = 0; i < 3;)
	{
		Serial2.write(0xff);
		i++;
	}

	ArduinoOTA
		.onStart([]() {
			String type;
			if (ArduinoOTA.getCommand() == U_FLASH)
				type = "sketch";
			else // U_SPIFFS
				type = "filesystem";

			// NOTE: if updating SPIFFS this would be the place to unmount SPIFFS using SPIFFS.end()
			Serial.println("Start updating " + type);
		})
		.onEnd([]() {
			Serial.println("\nEnd");
		})
		.onProgress([](unsigned int progress, unsigned int total) {
			Serial.printf("Progress: %u%%\r", (progress / (total / 100)));
		})
		.onError([](ota_error_t error) {
			Serial.printf("Error[%u]: ", error);
			if (error == OTA_AUTH_ERROR)
				Serial.println("Auth Failed");
			else if (error == OTA_BEGIN_ERROR)
				Serial.println("Begin Failed");
			else if (error == OTA_CONNECT_ERROR)
				Serial.println("Connect Failed");
			else if (error == OTA_RECEIVE_ERROR)
				Serial.println("Receive Failed");
			else if (error == OTA_END_ERROR)
				Serial.println("End Failed");
		});

	ArduinoOTA.begin();
}

void loop()
{
	ArduinoOTA.handle();

	/*--------------------------------意外保护--------------------------------------------*/
	{
		if (digitalRead(jingshui_chaoyakg) == 1) //锟斤拷水锟斤拷压锟斤拷锟斤拷
		{
			if (jingshui_chaoya_begin == 0)
			{
				xianshiping_sendorder2("zhuangtai", "净水超压停机，报售后");
				tiaoshi("净水超压，报售后");
				if (millis() > alarm_jiange + 180000)
				{
					edp_upload_string((String)hz[21], (String)hz[22]); //报警 净水超压停机，报售后
					alarm_jiange = millis();

					//	edp_upload_string("报警","净水超压");
				}

				closeall();
			}
			if (millis() > (jingshui_chaoya_begin + 8000))
			{
				jingshui_chaoya_begin = 0;
			}

			return;
		}

		if (feishuiguoshao == true) //废水过少故障停机
		{
			unsigned long dengdai;

			if (tiaoshikg == true)
			{
				dengdai = 60000;
			}
			else
			{
				dengdai = 1800000;
			}

			if (begintime_baohu == 0)
			{
				edp_upload_string("报警", "废水过少");
				begintime_baohu = millis();
				if (millis() > alarm_jiange + 180000)
				{
					alarm_jiange = millis();
					tiaoshi("废水过少故障停机,30分钟后试运行");
					edp_upload_string((String)hz[21], (String)hz[23]); //废水过少故障停机,30分钟后试运行
					xianshiping_sendorder2("zhuangtai", "废水过少故障等待");
					xianshiping_sendorder2("shuju", "废水过少故障停机,30分钟后试运行");
				}

				closeall();
				digitalWrite(jingshui, HIGH); //保持净水关闭，可能可以洗膜
			}
			endtime_baohu = millis();
			if (endtime_baohu - begintime_baohu > dengdai)
			{

				xianshiping_sendorder2("zhuangtai", "保护停机30分钟后试运行");
				tiaoshi("30分钟后试运行");

				feishuiguoshao_times = 0; //??锟斤拷
				begintime_baohu = 0;
				endtime_baohu = 0;
				feishuiguoshao = false;
				digitalWrite(jingshui, LOW);
			}

			return;

			//if(zhishui_starttime==0){ tiaoshi("zhishui=0") ;  }
		}

		if (alarm1 == true) //??????????
		{
			if (millis() > alarm_jiange + 180000)
			{
				alarm_jiange = millis();
				edp_upload_string((String)hz[21], (String)hz[24]); //报警 净水电磁阀关闭后不能水满
				xianshiping_sendorder2("shuju", "联系售后：17737203569 梁，开启紧急供水阀门");
				//xianshiping_sendorder2("guzh_tishi", "?????????7??????????????????????");
				tiaoshi("净水关闭输出7分钟后不能水满停机，报警停机");
				closeall();
			}

			return;
		}
	}

	/*-------------------?????????????---------------------------------*/
	while (Serial2.available() > 0 && parse_ready == false) //串口显示屏
	{
		buffer[buffer_index] = Serial2.read();
		/* if(buffer_index==0)     为了避免第一个字节是0xff，但很容易死机，不知为什么。2018.11.26晚
		  while (buffer[0] == 0xff)
			{
			buffer[0] == Serial2.read();
			}
		}*/

		if (buffer[buffer_index] == 0xff) //三个0xff结尾
		{

			buffer[buffer_index + 1] = Serial2.read(); //读第二个结束符
			if (buffer[buffer_index + 1] == 0xff)
			{
				buffer[buffer_index + 2] = Serial2.read(); //读第三个结束符
				{
					Serial.print("接收一次完整数据");
					serial_print(buffer, buffer_index + 3);
					//serial_print(buffer, buffer_index + 1);
					buffer_index = 0;   //????????
					parse_ready = true; //需要解析

					return; //没有接收到指示错误的命令后，查询需要发布显示屏的命令
							//提高串口处理速度，直接返回，效果很好
				}
			}
		}

		buffer_index++;
	}

	if (parse_ready == true)
	{
		Serial2_command_parse(); //获取页号和数据
		parse_ready = false;
		send_order(); //给串口屏回传数据
	}

	if (xsp_shezhi == true) //显示屏处理完数据再制水, //提高串口处理速度，直接返回
	{
		closeall();
		tiaoshi("显示屏设置运行参数，暂时停机");
		//xianshiping_sendorder2("zhuangtai","显示屏设置运行参数，暂时停机");
		edp_upload_string((String)hz[3], (String)hz[26]); // 状态 显示屏设置运行参数，暂时停机
		return;
	}
	//没有wifi，没有连接服务器，不用进入
	if (WiFi.status() == WL_CONNECTED && edp_client.connected() == true)
	{ /*------------------------------------edp接收命令------------------------------------------------*/
		while (edp_client.available())
		{

			int byte_count = edp_client.available();
			if (byte_count > 0) //??????
			{

				for (int e = 0; e < byte_count; e++)
				{
					edp_buffer[e] = edp_client.read();
				}
				rcvDebug(edp_buffer, byte_count);
				edp_command_parse();
				//memset(buffer, 0, 200);
			}
		}
	}
	/*------------------------------------定时心跳和wifi检查------------------------------------------*/
	//heart_beat_netcheck();//???????????????
	static unsigned long pre_bt = millis();
	if (millis() > pre_bt + 200000)
	{
		edp_heartbeat(); //可以确定edp是否连接状态
		tiaoshi("检查WiFi");
		if (edpConnected == false) //停锟斤拷状态锟铰斤拷锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷状态锟斤拷椋琫dp锟斤拷锟斤拷状态锟酵诧拷锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷
		{
			check_wifi();
		}
		pre_bt = millis(); //???4???????????.??????????
	}

	/*---------------------制水时间计算---------------------------------*/

	if (zhishui_starttime == 0 && digitalRead(gaoyabeng) == 1) //给开始时间赋值一次
	{
		zhishui_starttime = millis(); //
		zhishui_endtime = 0;
	}
	if (zhishui_endtime == 0 && digitalRead(gaoyabeng) == 0)
	{
		zhishui_endtime = millis(); //??????????
		tiaoshi((String)((int)((zhishui_endtime - zhishui_starttime) / 60000)));
		zhishuizongshijian = zhishuizongshijian + (int)((zhishui_endtime - zhishui_starttime) / 60000); //????
		//EEPROM.writeULong(60, 0);
		EEPROM.writeULong(60, zhishuizongshijian);											 //60???
		edp_upload_int((String)hz[31], zhishuizongshijian);									 //制水总时长
		edp_upload_int((String)hz[8], (int)((zhishui_endtime - zhishui_starttime) / 60000)); //单次制水时长	                                                                                         // p.putLong("zhishuizongshijian", zhishuizongshijian);                                            //锟斤拷???????????????锟斤拷
		decide_chaolv_chxi(zhishui_endtime - zhishui_starttime);
		zhishui_starttime = 0; //制水开始时间复位
	}

	if (guanbi == false) //允许运行
	{
		if (digitalRead(diyakg) == 0 && digitalRead(jingshui_chaoyakg == 0))
		{
			/*--------------------超滤冲洗--------------------------------*/
			if (digitalRead(gaoyabeng) == 0) //保证泵停止状态下冲洗超滤
			{
				if (chaolv_chxi == true) /*第一次启动冲洗或累积时间超过1小时冲洗*/
				{
					xianshiping_sendorder2("zhuangtai", "制水累计超过设定时间冲洗一次");
					edp_upload_string((String)hz[3], (String)hz[7]);
					tiaoshi("冲洗超滤");
					edp_upload_int((String)hz[0], chaolvchongxi_zongcishu); //超滤冲洗次数
					edp_upload_int((String)hz[1], count);					//超滤冲洗脉冲数
					chaolvchongxi();
				}
			}

			/*--------------------------------饮用净水制水------------------------------------------*/
			if (digitalRead(yinyong_gaoyakg) == 0 && shchan_zhishui == false) /*保证生产制水停止*/
			{
				if (xuyao_ximo == true)
				{
					xianshiping_sendorder2("zhuangtai", "饮用净水需要制水"); //洗膜时可以提示
				}
				if (xuyao_ximo == false)
				{									 /*------------------饮用净水过程1：进入一次 参数设定------------------------------------*/
					if (digitalRead(gaoyabeng) == 0) //只进入一次
					{
						xianshiping_sendorder2("zhuangtai", "开始饮用净水制水"); //
						tiaoshi("开始饮用净水制水");
						digitalWrite(zongjin, HIGH); //总进水打开
						digitalWrite(youxian, HIGH);
						digitalWrite(gaoyabeng, HIGH); /*??????*/
						digitalWrite(jingshui, HIGH);  //净水电磁阀关闭
						begintime = millis();		   //高压泵工作开始时间
						yinyong_zhishui = true;
						shchan_zhishui = false;
					}

					/*------------------饮用净水过程2：洗膜水提前储存------------------------------------*/
					if (digitalRead(gaoyabeng) == 1 && digitalRead(jingshui) == 1) /*制水中,,净水电磁阀关闭*/
					{
						xianshiping_sendorder2("zhuangtai", "净水电磁阀关闭，等待洗膜压力桶水满");
						edp_upload_string((String)hz[3], (String)hz[16]); //净水电磁阀关闭，等待洗膜压力桶水满
						if (digitalRead(ximo_gaoyakg) == 0)				  //洗膜高压开关没有断开
						{
							if (millis() > begintime + shuimandengdaishijian_set * 60000) //超过设定的分钟数，变成毫秒
							{
								//7????????锟斤拷????????????

								xianshiping_sendorder2("zhuangtai", "净水输出关闭" + (String)shuimandengdaishijian_set + "分钟后任然不能水满，故障停机"); //?????????7????????????????????????
								tiaoshi("净水输出关闭" + (String)shuimandengdaishijian_set + "分钟后任然不能水满，故障停机");

								delay(2000);
								alarm1 = true; //报警为真
								//closeall();    //关闭所有设备。
								return;
							}
						}
						if (digitalRead(ximo_gaoyakg) == 1) //洗膜高压开关断开，只进入一次
						{
							digitalWrite(jingshui, LOW); //净水电磁阀失电打开
							xianshiping_sendorder2("shuju", "洗膜压力桶" + String((millis() - begintime) / 60000) + "分钟水满");
							edp_upload_string((String)hz[3], (String)hz[17]); //洗膜高压开关断开
						}
					}

					/*------------------饮用净水过程3：开始制水------------------------------------*/

					if (digitalRead(gaoyabeng) == 1 && digitalRead(jingshui) == 0) /*?????,,????????????锟斤拷???*/
					{
						xianshiping_sendorder2("zhuangtai", "饮用净水制水中");
						edp_upload_string((String)hz[3], (String)hz[9]);
						xianshiping_sendorder2("shuju", "制水时水流脉冲最小值：" + (String)zhishui_maichong_biaozhun);
						xianshiping_sendorder2("zhuangtai", "制水单次设定：" + (String)zhishuishijian_set + "分钟");
						xianshiping_sendorder2("zhuangtai", "制水总分钟：" + (String)zhishuizongshijian);
						tiaoshi("制水脉冲标准：" + (String)zhishui_maichong_biaozhun);

						//if (millis() < (begintime + (zhishuishijian_set * 60000))) //制水时间不超过设定时间
						if (millis() < (begintime + (50 * 60000))) //制水时间不超过设定时间
						{
							detect(3000); //???????????????????

							xianshiping_sendorder2("shuju", "制水时脉冲数：" + (String)count);
							edp_upload_int((String)hz[10], count); //废水脉冲数
							xianshiping_sendorder2("zhuangtai", "饮用净水制水已用时：" + (String)((millis() - begintime) / 60000) + "分钟");

							if (count < zhishui_maichong_biaozhun)
							{
								feishuiguoshao_times++;
								String tt = itoa(feishuiguoshao_times, str, 10);

								xianshiping_sendorder2("zhuangtai", "废水过少:" + tt + "次");
							}
							else
							{
								xianshiping_sendorder2("zhuangtai", "废水流量正常");

								feishuiguoshao_times = 0;
							}
							if (feishuiguoshao_times >= 8)
							{
								xianshiping_sendorder2("zhuangtai", "废水过少布尔值为真");
								//xianshiping_sendorder2(0,"zhuangtai", "????");

								feishuiguoshao = true;
								return;
							}
						}
						/*------------------可能的饮用净水过程4：制水超时--------------------*/
						else //制水时间超过设定，只进入1次
						{
							edp_upload_string((String)hz[3], (String)hz[15]);

							xianshiping_sendorder2("zhuangtai", "制水时间超过单次设定时间");
							tiaoshi("制水时间超过单次设定时间");
							xuyao_ximo = true;
							//digitalWrite(gaoyabeng, LOW); //??????锟斤拷?????
							//digitalWrite(zongjin, LOW);   //???????

							chaolv_chxi = true; //需要冲洗超滤
							chaoshi_cishu++;

							xianshiping_sendorder2("shuju", "制水超时次数：" + (String)chaoshi_cishu); //??????????
						}
					}
				}
			}

			if (digitalRead(yinyong_gaoyakg) == 1) /*???????*/
			{
				edp_upload_string((String)hz[3], (String)hz[12]);	//饮用净水水满
				xianshiping_sendorder2("zhuangtai", "饮用净水水满"); //饮用净水水满
				tiaoshi("饮用净水水满");
				if (yinyong_zhishui == true) //???????
				{
					digitalWrite(zongjin, LOW); //???????
					digitalWrite(gaoyabeng, LOW);
					digitalWrite(youxian, LOW); //??????????
					yinyong_zhishui = false;
				}
			}
			/*----------------------------------------------生产用净水制水----------------------------------------*/

			if (digitalRead(shengchan_gaoyakg) == 0) /*???????????????????????????*/
			{
				static unsigned long pre_shch = millis();
				if (shchan_zhishui == false)
				{
					xianshiping_sendorder2("zhuangtai", "生产用净水需要制水"); //
				}
				if (digitalRead(yinyong_gaoyakg) == 0) //优先饮用净水制水
				{
					if (shchan_zhishui == true)
					{
						digitalWrite(zongjin, LOW); //???????
						digitalWrite(gaoyabeng, LOW);
						xianshiping_sendorder2("zhuang", "饮用净水不满，停止生产用净水制水");
						shchan_zhishui = false;
					}
				}
				if (xuyao_ximo == false && digitalRead(yinyong_gaoyakg) == 1) //
				{
					if (digitalRead(gaoyabeng) == 0) //???????
					{
						pre_shch = millis();
						xianshiping_sendorder2("zhuangtai", "生产用净水开始制水"); //??????,???????
						tiaoshi("生产用净水制水开始制水");
						digitalWrite(zongjin, HIGH);   /*锟斤拷锟杰斤拷水*/
						digitalWrite(gaoyabeng, HIGH); /*??????*/
						digitalWrite(jingshui, HIGH);  //关闭净水电磁阀
						shchan_zhishui = true;
						//begintime = millis(); //?????????????
					}
					/*------------------??????????-------------------------------------*/
					if (digitalRead(gaoyabeng) == 1 && digitalRead(jingshui) == 1) /*?????,,??????????*/
					{
						xianshiping_sendorder2("zhuangtai", "净水电磁阀关闭，等待洗膜压力桶水满");

						if (digitalRead(ximo_gaoyakg) == 0) //???????????锟斤拷??
						{

							if (millis() > pre_shch + shuimandengdaishijian_set * 60000) //?????趨???????????????
							{

								xianshiping_sendorder2("zhuangtai", "净水输出关闭" + (String)shuimandengdaishijian_set + "分钟后任然不能水满，故障停机"); //?????????7????????????????????????
								tiaoshi("设定时间内不能水满");
								alarm1 = true; //???????
								closeall();	//????????锟斤拷??
								digitalWrite(zongjin, LOW);
								return;
							}
						}
						if (digitalRead(ximo_gaoyakg) == 1) //洗膜锟斤拷压锟斤拷锟截断匡拷

						{
							xianshiping_sendorder2("shuju", "洗膜压力桶" + String((millis() - begintime) / 60000) + "分钟水满");
							edp_upload_string((String)hz[3], (String)hz[17]); //洗膜高压开关断开
							digitalWrite(jingshui, LOW);					  //锟斤拷水锟斤拷欧锟绞э拷锟斤拷
						}
					}

					/*------------------锟斤拷锟斤拷锟矫撅拷水锟斤拷水锟斤拷-------------------------------------*/

					if (digitalRead(gaoyabeng) == 1 && digitalRead(jingshui) == 0) /*洗膜高压开关断开后*/
					{
						xianshiping_sendorder2("zhuangtai", "生产用净水制水中");
						edp_upload_string((String)hz[3], (String)hz[18]); //状态 生产用净水制水中
						xianshiping_sendorder2("shuju", "制水时水流脉冲最小值：" + (String)zhishui_maichong_biaozhun);
						xianshiping_sendorder2("zhuangtai", "制水单次设定：" + (String)zhishuishijian_set + "分钟");
						xianshiping_sendorder2("shuju", "制水总分钟：" + (String)zhishuizongshijian);
						tiaoshi("制水脉冲标准：" + (String)zhishui_maichong_biaozhun);

						if (millis() < (pre_shch + (zhishuishijian_set * 60000))) //???????????趨???

						{
							detect(3000); //???????????????????
							xianshiping_sendorder2("shuju", "制水时脉冲数：" + (String)count);
							edp_upload_int((String)hz[10], count); //废水脉冲数
							xianshiping_sendorder2("zhuangtai", "生产用制水已用时：" + (String)((millis() - begintime) / 60000) + "分钟");

							if (count < zhishui_maichong_biaozhun)
							{
								feishuiguoshao_times++;
								String tt = itoa(feishuiguoshao_times, str, 10);

								xianshiping_sendorder2("zhuangtai", "废水过少:" + tt + "次");
							}
							else
							{
								xianshiping_sendorder2("zhuangtai", "废水流量正常");
								feishuiguoshao_times = 0;
							}
							if (tiaoshikg == false)
							{
								if (feishuiguoshao_times >= 8)
								{
									xianshiping_sendorder2("zhuangtai", "废水过少布尔值为真");
									feishuiguoshao = true;
									return;
								}
							}
						}
						else //????????1锟斤拷??????????1??
						{
							xuyao_ximo = true; //在洗膜程序里关闭高压泵和总进水

							edp_upload_string((String)hz[3], (String)hz[11]); //状态 生产用净水制水超时
							xianshiping_sendorder2("zhuangtai", "制水时间超过单次设定时间");
							edp_upload_string((String)hz[3], (String)hz[14]);
							tiaoshi("制水时间超过单次设定时间");

							// digitalWrite(jingshui, HIGH); /*????????????,?????????????*/
							chaolv_chxi = true; //??????????
							chaoshi_cishu++;

							xianshiping_sendorder2("shuju", "制水超时次数：" + (String)chaoshi_cishu); //??????????
						}
					}
				}
			}

			if (digitalRead(shengchan_gaoyakg) == 1)
			{
				edp_upload_string((String)hz[3], (String)hz[13]);	  //生产用净水水满
				xianshiping_sendorder2("zhuangtai", "生产用净水水满"); //
				tiaoshi("生产用净水水满");
				if (shchan_zhishui == true) //???????
				{
					digitalWrite(zongjin, LOW);
					digitalWrite(gaoyabeng, LOW);
					shchan_zhishui = false;
				}
				chaoshi_cishu = 0;
			}
			/*??????????????????????????,??????*/
			if (xuyao_ximo == true)
			{
				static unsigned long pre_ximo = millis();
				if (digitalRead(gaoyabeng) == 1) //运行一次
				{
					pre_ximo = millis();
					digitalWrite(gaoyabeng, LOW);
					digitalWrite(zongjin, LOW);
				}

				xianshiping_sendorder2("zhuangtai", "强制停机洗膜");
				edp_upload_string((String)hz[3], (String)hz[19]);												  //强制停机洗膜
				xianshiping_sendorder2("zhuangtai", "洗膜设定时长：" + (String)(jingshuiximo_shichang) + "分钟"); //???趨???????
				delay(1000);

				if (millis() < pre_ximo + jingshuiximo_shichang * 60000) //??? ,????????,??????
				{
					//tiaoshi("?????????" + (String)(endtime - begintime) / 60000 + "????");
					detect(3000);
					xianshiping_sendorder2("shuju", "洗膜时水流脉冲数：" + (String)count);
					edp_upload_int((String)hz[27], count);																	  //??????
					xianshiping_sendorder2("zhuangtai", "洗膜已用时：" + (String)((millis() - ximo_begin) / 60000) + "分钟"); //?????

					// endtime = millis();
				}
				else //??????????趨???
				{
					xianshiping_sendorder2("zhuangtai", "净水洗膜结束"); //?????????
					edp_upload_string((String)hz[3], (String)hz[20]);	//"强制净水洗膜结束"
					xuyao_ximo = false;
				}
			}
		}
		else
		{
			static unsigned long pre_queshui = millis(); //缺水状态下如果没有延时会大量发送数据造成显示屏回传错误报警,间隔给显示屏数据
			if (millis() > pre_queshui + 20000)			 //20秒
			{
				pre_queshui = millis();
				xianshiping_sendorder2("zhuangtai", "缺水停机");
				edp_upload_string((String)hz[3], (String)hz[4]); //状态 缺水停机

				tiaoshi("缺水提示一次");
				// if(Serial2.available()==0){     tiaoshi("?????");}
				closeall();
				digitalWrite(zongjin, HIGH);
			}
			if (digitalRead(zongjin) == 0 && digitalRead(gaoyabeng) == 0) //???? ??????
			{
				xianshiping_sendorder2((String)hz[3], (String)hz[5]); //状态 漏水或膜进水电磁阀关闭不严！
			}
		}
	}
	else
	{
		xianshiping_sendorder2("zhuangtai", "远程主动停机状态");
		closeall();
	}

	static unsigned long pre_wendu = millis();
	if (millis() > pre_wendu + 60000) //1分钟
	{
		pre_wendu = millis();
		sensors.requestTemperatures(); // Send the command to get temperatures
		tempC = sensors.getTempC(address_18b20);
		xianshiping_sendorder2("zhuangtai", "机箱内温度" + (String)tempC);
		edp_upload_int((String)hz[2], tempC); //温度
		if (tempC < 5)
		{
			digitalWrite(jiare, HIGH);
		}
		if (tempC > 10)
		{
			digitalWrite(jiare, LOW);
		}
	}

	
}
